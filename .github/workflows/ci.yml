name: ğŸ§ª Comprehensive Unit Tests CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸš€ Run Unit Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go-version: [1.21, 1.22]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}

    - name: ğŸ“¦ Cache Go Modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: ğŸ” Verify Dependencies
      run: go mod verify

    - name: ğŸ“¥ Download Dependencies
      run: go mod download

    - name: ğŸ”¨ Build Application
      run: go build -v ./...

    - name: ğŸ§ª Run ALL Unit Tests
      run: |
        echo "ğŸ§ª Running comprehensive unit test suite..."
        echo "Testing ALL functions in internal/ folder"
        go test ./internal/... -v -race -coverprofile=coverage.out

    - name: ğŸ“Š Generate Coverage Report
      run: |
        go tool cover -html=coverage.out -o coverage.html
        go tool cover -func=coverage.out -o coverage.txt

    - name: ğŸ“ˆ Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella

    - name: ğŸ’¾ Archive Coverage Results
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-go${{ matrix.go-version }}
        path: |
          coverage.out
          coverage.html
          coverage.txt

    - name: ğŸ¯ Test Specific Packages
      run: |
        echo "ğŸ” Testing individual packages..."
        echo "ğŸ“ Config Package Tests:"
        go test ./internal/config -v
        echo "ğŸ—ƒï¸  Models Package Tests:"
        go test ./internal/models -v
        echo "ğŸ›¡ï¸  Middleware Package Tests:"
        go test ./internal/middleware -v
        echo "ğŸ”§ Utils Package Tests:"
        go test ./internal/utils -v
        echo "ğŸ—„ï¸  Database Package Tests:"
        go test ./internal/database -v

    - name: âš¡ Performance Tests
      run: |
        echo "âš¡ Running benchmark tests..."
        go test ./internal/... -bench=. -benchmem

    - name: ğŸ” Race Condition Detection
      run: |
        echo "ğŸ” Checking for race conditions..."
        go test ./internal/... -race

    - name: ğŸ“Š Test Summary Report
      run: |
        echo "ğŸ“Š TEST SUMMARY REPORT"
        echo "====================="
        echo "âœ… All unit tests in internal/ folder executed"
        echo "âœ… Coverage report generated"
        echo "âœ… Race condition detection completed"
        echo "âœ… Performance benchmarks executed"
        echo ""
        echo "ğŸ“ˆ Coverage Summary:"
        cat coverage.txt | tail -1

  lint:
    name: ğŸ” Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.22

    - name: ğŸ” Run golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        args: --timeout=5m

    - name: ğŸ”§ Go Format Check
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ Code is not properly formatted. Run 'go fmt ./...' to fix."
          gofmt -s -l .
          exit 1
        fi
        echo "âœ… Code is properly formatted"

    - name: ğŸ” Go Vet
      run: go vet ./...

    - name: ğŸ›¡ï¸ Security Check
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: './...'

  test-matrix:
    name: ğŸŒ Cross-Platform Test Matrix
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        go-version: [1.21, 1.22]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}

    - name: ğŸ§ª Run Unit Tests
      run: go test ./internal/... -v

    - name: ğŸ“Š Platform Test Report
      run: |
        echo "âœ… Tests passed on ${{ matrix.os }} with Go ${{ matrix.go-version }}"

  notify:
    name: ğŸ“¢ Test Results Notification
    runs-on: ubuntu-latest
    needs: [test, lint, test-matrix]
    if: always()

    steps:
    - name: ğŸ‰ Success Notification
      if: needs.test.result == 'success' && needs.lint.result == 'success' && needs.test-matrix.result == 'success'
      run: |
        echo "ğŸ‰ ALL TESTS PASSED!"
        echo "âœ… Comprehensive unit tests: PASSED"
        echo "âœ… Code quality checks: PASSED"
        echo "âœ… Cross-platform tests: PASSED"
        echo "ğŸš€ Ready for deployment!"

    - name: âŒ Failure Notification
      if: needs.test.result == 'failure' || needs.lint.result == 'failure' || needs.test-matrix.result == 'failure'
      run: |
        echo "âŒ TESTS FAILED!"
        echo "Test results: ${{ needs.test.result }}"
        echo "Lint results: ${{ needs.lint.result }}"
        echo "Matrix results: ${{ needs.test-matrix.result }}"
        echo "ğŸ”§ Please fix issues before merging"
        exit 1