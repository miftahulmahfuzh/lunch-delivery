{{template "base" .}}
{{define "content"}}
<style>
.chrome-tab {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    margin-top: 8px;
    background: #10b981;
    border: none;
    border-radius: 8px 8px 0 0;
    color: white;
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    position: relative;
    min-height: 40px;
}
.chrome-tab:hover {
    background: #059669;
    color: white;
}
.chrome-tab-active {
    background: #ffffff;
    color: #10b981;
    font-weight: 600;
    border: 2px solid #10b981;
    border-bottom: none;
    z-index: 10;
    margin-bottom: -2px;
}
.chrome-tab-active:hover {
    background: #ffffff;
    color: #059669;
}
.chrome-tab-disabled {
    background: linear-gradient(to bottom, #f3f4f6 0%, #e5e7eb 100%);
    color: #9ca3af;
    cursor: not-allowed;
}
</style>
<main class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-100">
    <!-- Navigation -->
    <nav class="border-b border-gray-200 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-end justify-between h-16 -mb-px">
                <div class="flex items-end space-x-1">
                    <a href="/my-orders" class="chrome-tab">
                        <i class="fas fa-clipboard-list mr-2"></i>
                        <span>My Orders</span>
                    </a>
                    <span class="chrome-tab chrome-tab-active">
                        <i class="fas fa-edit mr-2"></i>
                        <span>Edit Orders</span>
                    </span>
                </div>
                <div class="flex items-end">
                    <a href="/logout" class="chrome-tab !text-white hover:!text-gray-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-16">
        <!-- Page Header -->
        <div class="text-center mb-10 animate-fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-primary-500 to-primary-600 rounded-3xl shadow-xl mb-6">
                <i class="fas fa-shopping-cart text-white text-3xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-900 mb-3">Place Your Order</h1>
            <div class="flex items-center justify-center space-x-8 text-lg text-gray-600">
                <div class="flex items-center">
                    <i class="fas fa-calendar-day text-primary-500 mr-2"></i>
                    <span class="font-medium">{{.session.Date.Format "January 2, 2006"}}</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-building text-accent-500 mr-2"></i>
                    <span class="font-medium">{{.company.Name}}</span>
                </div>
            </div>
        </div>

        <!-- Status Alerts -->
        {{if .existing_order}}
        <div class="mb-8 animate-slide-up">
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-500 text-lg mt-0.5"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Order Exists</h3>
                    <p class="mt-1 text-sm text-blue-700">You already have an order for today. Submitting will update your existing order.</p>
                </div>
            </div>
        </div>
        {{end}}

        {{if .show_reset_notification}}
        <div class="mb-8 animate-slide-up">
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-amber-500 text-lg mt-0.5"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-amber-800">Menu Updated!</h3>
                    <p class="mt-1 text-sm text-amber-700">The admin has updated today's menu. Your previous nutritionist selection may no longer be optimal. Consider using "AI Nutritionist" again for updated recommendations.</p>
                </div>
            </div>
        </div>
        {{end}}

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <!-- Menu Selection -->
            <div class="xl:col-span-2">
                <div class="bg-white rounded-2xl shadow-xl border border-gray-200/50 overflow-hidden">
                    <div class="bg-gradient-to-r from-primary-500 to-primary-600 px-6 py-4">
                        <h2 class="text-xl font-semibold text-white flex items-center">
                            <i class="fas fa-utensils mr-3"></i>
                            Today's Menu
                        </h2>
                        <p class="text-primary-100 text-sm mt-1">Select your favorite dishes</p>
                    </div>

                    <form method="POST" action="/order" id="orderForm" class="p-6">
                        <input type="hidden" name="session_id" value="{{.session.ID}}">

                        <!-- Action Buttons -->
                        <div class="mb-6 flex flex-wrap gap-3">
                            <button type="button" id="selectAllBtn" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-all duration-200 font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-check-double mr-2"></i>
                                Select All
                            </button>
                            <button type="button" id="unselectAllBtn" class="inline-flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all duration-200 font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-times-circle mr-2"></i>
                                Clear All
                            </button>
                            <button type="button" id="nutritionistBtn" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-brain mr-2"></i>
                                AI Nutritionist
                            </button>
                        </div>

                        <!-- Search Bar -->
                        <div class="mb-6">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="menuSearch" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Search menu items...">
                            </div>
                        </div>

                        <!-- Menu Items Grid -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            {{range $index, $item := .menu_items}}
                            {{$isStockEmpty := false}}
                            {{range $.stock_empty_items}}
                                {{if eq . $item.ID}}
                                    {{$isStockEmpty = true}}
                                {{end}}
                            {{end}}

                            <div class="menu-item group relative {{if $isStockEmpty}}bg-gray-200 cursor-pointer opacity-60{{else}}bg-gray-50{{end}} hover:bg-primary-50 hover:border-primary-200 transform hover:scale-[1.02] hover:shadow-lg rounded-xl p-4 transition-all duration-300 border-2 border-transparent"
                                 data-index="{{$index}}" {{if $isStockEmpty}}data-stock-empty="true"{{end}}>
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 pr-3">
                                        <h3 class="font-semibold {{if $isStockEmpty}}text-gray-500{{else}}text-gray-900 group-hover:text-primary-700{{end}} transition-colors leading-tight">
                                            {{$item.Name}}
                                            {{if $isStockEmpty}}
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 ml-2">
                                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                                    Out of Stock
                                                </span>
                                            {{end}}
                                        </h3>
                                        <div class="flex items-center mt-2">
                                            <span class="text-2xl font-bold {{if $isStockEmpty}}text-gray-500{{else}}text-primary-600{{end}}">Rp {{$item.Price | divideBy100}}</span>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <div class="w-7 h-7 border-2 border-gray-300 group-hover:border-primary-400 rounded-full flex items-center justify-center transition-colors checkbox-indicator">
                                            <i class="fas fa-check text-primary-600 text-sm hidden"></i>
                                        </div>
                                    </div>
                                </div>
                                <input type="checkbox" name="menu_items" value="{{$item.ID}}" id="item-{{$item.ID}}"
                                       data-price="{{$item.Price}}" {{if $isStockEmpty}}data-out-of-stock="true"{{end}} class="hidden menu-checkbox"
                                       {{if $.existing_order}}
                                           {{$currentID := $item.ID}}
                                           {{range $.existing_order.MenuItemIDs}}
                                               {{if eq . $currentID}}checked{{end}}
                                           {{end}}
                                       {{end}}>
                            </div>
                            {{end}}
                        </div>

                        <!-- AI Nutritionist Result -->
                        <div id="nutritionistResult" class="hidden mb-20 bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-xl p-6 animate-slide-up">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-blue-500 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-brain text-white"></i>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <h3 class="font-semibold text-gray-900 mb-2 flex items-center">
                                        AI Nutritionist Recommendation
                                        <span class="ml-2 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">Smart Selection</span>
                                    </h3>
                                    <p id="nutritionistReasoning" class="text-gray-700 mb-3 leading-relaxed"></p>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                        <div class="bg-white/60 rounded-lg p-3">
                                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Protein</div>
                                            <div id="proteinLevel" class="font-semibold text-gray-900 mt-1"></div>
                                        </div>
                                        <div class="bg-white/60 rounded-lg p-3">
                                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Vegetables</div>
                                            <div id="vegetableLevel" class="font-semibold text-gray-900 mt-1"></div>
                                        </div>
                                        <div class="bg-white/60 rounded-lg p-3">
                                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Rating</div>
                                            <div id="overallRating" class="font-semibold text-gray-900 mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="xl:col-span-1">
                <div id="orderSummaryContainer" class="bg-white rounded-2xl shadow-xl border border-gray-200/50 sticky top-20">
                    <div class="bg-gradient-to-r from-accent-500 to-accent-600 px-6 py-4 rounded-t-2xl">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-receipt mr-3"></i>
                            Order Summary
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="selectedItems" class="mb-6">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-utensils text-3xl mb-3 text-gray-300"></i>
                                <p>No items selected</p>
                                <p class="text-sm">Choose your favorite dishes</p>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-4">
                            <div class="flex items-center justify-between text-xl font-bold">
                                <span class="text-gray-900">Total:</span>
                                <span class="text-primary-600">Rp <span id="totalPrice">0</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Order Tips Card (now inside the sticky container) -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border border-blue-200 p-6 m-6 mt-0">
                        <h4 class="font-semibold text-blue-900 mb-3 flex items-center">
                            <i class="fas fa-lightbulb text-blue-500 mr-2"></i>
                            Order Tips
                        </h4>
                        <ul class="space-y-2 text-sm text-blue-800">
                            <li class="flex items-start">
                                <i class="fas fa-check text-blue-500 mr-2 mt-0.5 text-xs"></i>
                                <span>Use AI Nutritionist for balanced meals</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-blue-500 mr-2 mt-0.5 text-xs"></i>
                                <span>Orders can be updated until deadline</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-blue-500 mr-2 mt-0.5 text-xs"></i>
                                <span>Mix proteins and vegetables for health</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Floating Submit Button -->
    <div id="floatingButtonContainer" class="fixed bottom-8 z-50 transition-all duration-300 opacity-0 pointer-events-none">
        <div id="blurArea" class="relative transition-all duration-300" style="padding: 3rem;">
            <!-- Gradual blur background with mask -->
            <div class="absolute inset-0 backdrop-blur-sm bg-white/10 transition-all duration-300" style="
                mask: radial-gradient(ellipse 140px 100px at center, rgba(0,0,0,1) 30%, rgba(0,0,0,0.8) 50%, rgba(0,0,0,0.4) 70%, rgba(0,0,0,0) 100%);
                -webkit-mask: radial-gradient(ellipse 140px 100px at center, rgba(0,0,0,1) 30%, rgba(0,0,0,0.8) 50%, rgba(0,0,0,0.4) 70%, rgba(0,0,0,0) 100%);
            "></div>
            <div class="relative">
                <button type="submit" form="orderForm" class="inline-flex items-center justify-center px-8 py-4 bg-gradient-to-r from-primary-600 to-primary-700 text-white rounded-xl hover:from-primary-700 hover:to-primary-800 transition-all duration-300 font-semibold text-lg shadow-xl hover:shadow-2xl transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none" id="floatingSubmitBtn">
                    <i class="fas fa-paper-plane mr-3"></i>
                    {{if .existing_order}}Update My Order{{else}}Place Order{{end}}
                </button>
            </div>
        </div>
    </div>
</main>

<script>
function calculateTotal() {
    const checkboxes = document.querySelectorAll('input[name="menu_items"]:checked');
    let total = 0;
    let summaryHtml = '';

    if (checkboxes.length === 0) {
        document.getElementById('selectedItems').innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-utensils text-3xl mb-3 text-gray-300"></i>
                <p>No items selected</p>
                <p class="text-sm">Choose your favorite dishes</p>
            </div>
        `;
        document.getElementById('floatingSubmitBtn').disabled = true;
    } else {
        let itemsHtml = '<div class="space-y-3">';
        
        checkboxes.forEach((checkbox, index) => {
            const price = parseInt(checkbox.dataset.price, 10);
            const isOutOfStock = checkbox.dataset.outOfStock === 'true';
            const itemText = checkbox.parentElement.querySelector('h3').textContent.trim();
            
            if (!isOutOfStock) {
                total += price;
            }
            
            if (isOutOfStock) {
                itemsHtml += `
                    <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg border border-gray-300 text-gray-500">
                        <div class="flex-1">
                            <p class="font-medium text-gray-500 text-sm">${itemText.replace(/\s*Out of Stock.*$/, '')} - <span class="text-xs italic">Out of Stock</span></p>
                        </div>
                        <div class="text-gray-400 font-semibold line-through">
                            Rp ${price.toLocaleString('en-US')}
                        </div>
                    </div>
                `;
            } else {
                itemsHtml += `
                    <div class="flex items-center justify-between p-3 bg-primary-50 rounded-lg border border-primary-200">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900 text-sm">${itemText}</p>
                        </div>
                        <div class="text-primary-600 font-semibold">
                            Rp ${price.toLocaleString('en-US')}
                        </div>
                    </div>
                `;
            }
        });
        
        itemsHtml += '</div>';
        document.getElementById('selectedItems').innerHTML = itemsHtml;
        const hasInStockItems = Array.from(checkboxes).some(checkbox => checkbox.dataset.outOfStock !== 'true');
        document.getElementById('floatingSubmitBtn').disabled = !hasInStockItems;
    }

    document.getElementById('totalPrice').textContent = total.toLocaleString('en-US');
}

document.addEventListener('DOMContentLoaded', function() {
    const menuItems = document.querySelectorAll('.menu-item');
    const nutritionistBtn = document.getElementById('nutritionistBtn');
    const nutritionistResult = document.getElementById('nutritionistResult');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const unselectAllBtn = document.getElementById('unselectAllBtn');

    menuItems.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const checkboxIndicator = item.querySelector('.checkbox-indicator i');

        if (checkbox.checked) {
            item.classList.add('selected', 'bg-primary-100', 'border-primary-300');
            item.classList.remove('bg-gray-50');
            checkboxIndicator.classList.remove('hidden');
        }

        item.addEventListener('click', function() {
            checkbox.checked = !checkbox.checked;
            this.classList.toggle('selected');
            
            if (this.classList.contains('selected')) {
                this.classList.add('bg-primary-100', 'border-primary-300');
                this.classList.remove('bg-gray-50');
                checkboxIndicator.classList.remove('hidden');
            } else {
                this.classList.remove('bg-primary-100', 'border-primary-300');
                this.classList.add('bg-gray-50');
                checkboxIndicator.classList.add('hidden');
            }
            calculateTotal();
        });
    });

    selectAllBtn.addEventListener('click', function() {
        menuItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            const checkboxIndicator = item.querySelector('.checkbox-indicator i');
            
            checkbox.checked = true;
            item.classList.add('selected', 'bg-primary-100', 'border-primary-300');
            item.classList.remove('bg-gray-50');
            checkboxIndicator.classList.remove('hidden');
        });
        calculateTotal();
    });

    unselectAllBtn.addEventListener('click', function() {
        clearAllSelections();
        calculateTotal();
    });

    nutritionistBtn.addEventListener('click', function() {
        const btn = this;
        const originalHtml = btn.innerHTML;

        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>AI Thinking...';
        btn.disabled = true;
        btn.classList.add('opacity-75');

        nutritionistResult.classList.add('hidden');

        const pathParts = window.location.pathname.split('/');
        const company = pathParts[2];
        const date = pathParts[3];

        fetch(`/order/${company}/${date}/nutritionist-select`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                clearAllSelections();
                selectItemsByIndices(data.selected_indices);
                displayNutritionistResult(data);
                calculateTotal();
            } else {
                alert('Error: ' + (data.error || 'Nutritionist selection failed'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred. Please try again.');
        })
        .finally(() => {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            btn.classList.remove('opacity-75');
        });
    });

    function clearAllSelections() {
        menuItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            const checkboxIndicator = item.querySelector('.checkbox-indicator i');
            
            checkbox.checked = false;
            item.classList.remove('selected', 'bg-primary-100', 'border-primary-300');
            item.classList.add('bg-gray-50');
            checkboxIndicator.classList.add('hidden');
        });
    }

    function selectItemsByIndices(indices) {
        indices.forEach(index => {
            if (index >= 0 && index < menuItems.length) {
                const item = menuItems[index];
                const checkbox = item.querySelector('input[type="checkbox"]');
                const checkboxIndicator = item.querySelector('.checkbox-indicator i');
                
                checkbox.checked = true;
                item.classList.add('selected', 'bg-primary-100', 'border-primary-300');
                item.classList.remove('bg-gray-50');
                checkboxIndicator.classList.remove('hidden');
            }
        });
    }

    function displayNutritionistResult(data) {
        document.getElementById('nutritionistReasoning').textContent = data.reasoning;
        document.getElementById('proteinLevel').textContent = data.nutritional_summary.protein || 'Unknown';
        document.getElementById('vegetableLevel').textContent = data.nutritional_summary.vegetables || 'Unknown';
        document.getElementById('overallRating').textContent = data.nutritional_summary.overall_rating || 'Balanced';

        nutritionistResult.classList.remove('hidden');

        // Auto-scroll to AI Nutritionist Recommendation section
        setTimeout(() => {
            nutritionistResult.scrollIntoView({
                behavior: 'smooth',
                block: 'start',
                inline: 'nearest'
            });
        }, 200); // Small delay to ensure the element is fully visible

        // Recalculate floating button position after showing nutritionist result
        setTimeout(handleFloatingButton, 300);
    }

    calculateTotal();

    // Search functionality
    const searchInput = document.getElementById('menuSearch');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        menuItems.forEach(item => {
            const itemName = item.querySelector('h3').textContent.toLowerCase();
            if (itemName.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // Handle floating button positioning based on scroll
    function handleFloatingButton() {
        const floatingContainer = document.getElementById('floatingButtonContainer');
        const blurArea = document.getElementById('blurArea');
        const menuColumn = document.querySelector('.xl\\:col-span-2'); // Today's Menu column
        const menuBox = menuColumn?.querySelector('.bg-white.rounded-2xl'); // The white menu box
        const nutritionistResult = document.getElementById('nutritionistResult');
        const menuItemsGrid = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2.gap-4.mb-4');

        if (!menuColumn || !menuBox || !blurArea) return;

        const documentHeight = document.documentElement.scrollHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollBottom = scrollTop + windowHeight;

        // Get menu column and box dimensions
        const menuColumnRect = menuColumn.getBoundingClientRect();
        const menuBoxRect = menuBox.getBoundingClientRect();
        const menuColumnOffset = menuColumn.offsetLeft;
        const menuColumnWidth = menuColumn.offsetWidth;
        const menuBoxBottom = menuBox.offsetTop + menuBox.offsetHeight;

        // Calculate the actual content bottom (considering AI Nutritionist box if visible)
        let contentBottom = menuBoxBottom;
        if (nutritionistResult && !nutritionistResult.classList.contains('hidden')) {
            // If AI Nutritionist is visible, use its bottom position
            contentBottom = nutritionistResult.offsetTop + nutritionistResult.offsetHeight;
        }

        // Check if menu items grid is visible and user has scrolled past the first few menu items
        let shouldShowButton = false;
        if (menuItemsGrid) {
            const menuItemsRect = menuItemsGrid.getBoundingClientRect();
            const menuItemsTop = menuItemsGrid.offsetTop;
            // Show button when user has scrolled down enough to see at least 200px of menu items
            shouldShowButton = scrollTop > (menuItemsTop - windowHeight + 200);
        }

        // Check if user has scrolled to the bottom or if the content bottom is visible
        const threshold = 50;
        const isAtPageBottom = scrollBottom >= documentHeight - threshold;
        const isContentBottomVisible = scrollTop + windowHeight >= contentBottom;

        if (!shouldShowButton) {
            // Hide the button when not scrolled enough
            floatingContainer.style.opacity = '0';
            floatingContainer.style.pointerEvents = 'none';
            return;
        } else {
            // Show the button when scrolled enough
            floatingContainer.style.opacity = '1';
            floatingContainer.style.pointerEvents = 'auto';
        }

        if (isAtPageBottom || isContentBottomVisible) {
            // When at bottom or content bottom is visible, position it inside the menu box at the bottom
            floatingContainer.style.position = 'absolute';
            floatingContainer.style.top = (contentBottom - 160) + 'px'; // Position inside the box, 160px from bottom for more clearance
            floatingContainer.style.left = menuColumnOffset + (menuColumnWidth / 2) + 'px';
            floatingContainer.style.width = 'auto';
            floatingContainer.style.bottom = 'auto';
            floatingContainer.style.transform = 'translateX(-50%)';
            floatingContainer.style.display = 'block';
            floatingContainer.style.justifyContent = 'unset';
            floatingContainer.style.paddingLeft = '0';
            floatingContainer.style.paddingRight = '0';
            // Hide blur background when fixed at bottom
            const blurBackground = blurArea.querySelector('.absolute.inset-0');
            if (blurBackground) {
                blurBackground.style.opacity = '0';
            }
            blurArea.style.padding = '0';
        } else {
            // When not at bottom, keep it floating centered in the menu column
            floatingContainer.style.position = 'fixed';
            floatingContainer.style.bottom = '32px';
            floatingContainer.style.top = 'auto';
            floatingContainer.style.left = menuColumnOffset + (menuColumnWidth / 2) + 'px';
            floatingContainer.style.width = 'auto';
            floatingContainer.style.transform = 'translateX(-50%)';
            floatingContainer.style.display = 'block';
            floatingContainer.style.justifyContent = 'unset';
            floatingContainer.style.paddingLeft = '0';
            floatingContainer.style.paddingRight = '0';
            // Show blur background when floating
            const blurBackground = blurArea.querySelector('.absolute.inset-0');
            if (blurBackground) {
                blurBackground.style.opacity = '1';
            }
            blurArea.style.padding = '3rem';
        }
    }

    // Add scroll event listener
    window.addEventListener('scroll', handleFloatingButton);
    window.addEventListener('resize', handleFloatingButton);
    
    // Initial call
    handleFloatingButton();

    // Show error modal if needed (for JavaScript error handling)
    function showErrorModal(title, message) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
                <div class="p-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mr-4">
                            <i class="fas fa-exclamation-circle text-red-500 text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${title}</h3>
                            <p class="text-gray-600">${message}</p>
                        </div>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (modal.parentNode) {
                modal.remove();
            }
        }, 5000);
    }
});
</script>
{{end}}
