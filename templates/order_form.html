<!-- templates/order_form.html -->
{{define "content"}}
<div class="container">
    <div class="nav">
        <a href="/my-orders">My Orders</a>
        <a href="/logout">Logout</a>
    </div>

    <div class="card">
        <h2>Order for {{.session.Date.Format "January 2, 2006"}}</h2>

        {{if .existing_order}}
            <div class="success">You already have an order for today. Submitting will update your existing order.</div>
        {{end}}

        <form method="POST" action="/order" id="orderForm">
            <input type="hidden" name="session_id" value="{{.session.ID}}">

            <div class="form-group">
                <label>Select Your Menu Items:</label>
                <div class="checkbox-group">
                    {{range .menu_items}}
                    <div class="checkbox-item">
                        <input type="checkbox" name="menu_items" value="{{.ID}}" id="item-{{.ID}}"
                               data-price="{{.Price}}" onchange="calculateTotal()"
                               {{if $.existing_order}}
                                   {{range $.existing_order.MenuItemIDs}}
                                       {{if eq . $.ID}}checked{{end}}
                                   {{end}}
                               {{end}}>
                        <label for="item-{{.ID}}">{{.Name}} - Rp {{.Price | divideBy100}}</label>
                    </div>
                    {{end}}
                </div>
            </div>

            <div class="card" style="background: #e9ecef;">
                <h4>Order Summary</h4>
                <div id="selectedItems"></div>
                <div><strong>Total: Rp <span id="totalPrice">0</span></strong></div>
            </div>

            <button type="submit" class="btn btn-success">{{if .existing_order}}Update Order{{else}}Submit Order{{end}}</button>
        </form>
    </div>
</div>

<script>
function calculateTotal() {
    const checkboxes = document.querySelectorAll('input[name="menu_items"]:checked');
    let total = 0;
    let selectedItems = [];

    checkboxes.forEach(checkbox => {
        const price = parseInt(checkbox.dataset.price);
        total += price;
        selectedItems.push(checkbox.nextElementSibling.textContent);
    });

    document.getElementById('totalPrice').textContent = (total / 100).toFixed(0);
    document.getElementById('selectedItems').innerHTML = selectedItems.length > 0 ?
        '<ul>' + selectedItems.map(item => '<li>' + item + '</li>').join('') + '</ul>' :
        '<p>No items selected</p>';
}

// Calculate total on page load
document.addEventListener('DOMContentLoaded', calculateTotal);
</script>
{{end}}
